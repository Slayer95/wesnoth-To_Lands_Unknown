#textdomain wesnoth-To_Lands_Unknown

#define TLU_ITEM_TAKE_ACTION ID NAME IMAGE OBJ_TEXT CAN_TAKE_FILTER_WML X Y ICON OBJ_EFFECT TRAIT_TEXT
    [object]
        name={NAME}
        image={IMAGE}
        duration=forever
        description={OBJ_TEXT}
        [filter]
            {CAN_TAKE_FILTER_WML}
            x,y={X},{Y}
        [/filter]
        [effect]
            apply_to=overlay
            add="misc/blank-hex.png~BLIT({ICON},$unit.variables.artifact_count,0)"
        [/effect]
        {OBJ_EFFECT}
    [/object]
    [store_unit]
        [filter]
            ## id=$unit.id
            x,y={X},{Y}
        [/filter]
        variable=unit
    [/store_unit]
    [set_variables]
        name=unit.modifications.trait
        mode=append

        [value]
            id={ID} # wmllint: ignore
            name={NAME}
            description={TRAIT_TEXT}
        [/value]
    [/set_variables]
    {VARIABLE_OP unit.variables.artifact_count add 10}
    [unstore_unit]
        variable=unit
        find_vacant=no
    [/unstore_unit]

    [set_variable]
        name=item_{ID}_picked_up
        value=yes
    [/set_variable]
    [set_variable]
        name=item_{ID}_in_use
        value=yes
    [/set_variable]

    {IF_VAR unit.id equals Mehir (
        [then]
            [fire_event]
                name=stylish
            [/fire_event]
        [/then]
    )}

    #call item-specific event if exists
    [fire_event]
        name=post_take_{ID}
        [primary_unit]
            x,y={X},{Y}
        [/primary_unit]
    [/fire_event]
#enddef

#define TLU_PICKUPPABLE_ITEM ID NAME X Y CAN_TAKE_FILTER_WML IMAGE IMAGE2 ICON TEXT OBJ_TEXT TRAIT_TEXT TAKE_IT_STRING LEAVE_IT_STRING OBJ_EFFECT
    [item]
        x,y={X},{Y}
        image={IMAGE}
    [/item]

    [event]
        id=artifact_{ID}_event
        name=moveto
        first_time_only=no

        [filter]
            x,y={X},{Y}
            side=1
        [/filter]

        [message]
            speaker=narrator
            message={TEXT}
            image={IMAGE2}

            [option]
                #equip the item
                [show_if]
                    [have_unit]
                        x,y={X},{Y}
                        {CAN_TAKE_FILTER_WML}
                        side=1
                        #Rashti cannot equip artifacts
                        [not]
                            id=Rashti
                        [/not]
                    [/have_unit]
                [/show_if]
                message={TAKE_IT_STRING}

                [command]
                    {TLU_ITEM_TAKE_ACTION {ID} {NAME} {IMAGE} {OBJ_TEXT} {CAN_TAKE_FILTER_WML} {X} {Y} {ICON} {OBJ_EFFECT} {TRAIT_TEXT}}

                    {REMOVE_IMAGE {X} {Y}}
                    [remove_item]
                        x,y={X},{Y}
                        image={IMAGE}
                    [/remove_item]

                    #remove self
                    [remove_event]
                        id=artifact_{ID}_event
                    [/remove_event]
                [/command]
            [/option]
            [option]
                #collect only
                [show_if]
                    [have_unit]
                        x,y={X},{Y}
                        side=1
                        [not]
                            #these units lack physical capabilities to collect an item without damaging or destroying it
                            type=EoMa_Fire_Elemental,EoMa_Fire_Avatar,EoMa_Fire_God,EoMa_Air_Elemental,EoMa_Air_Avatar,EoMa_Air_God,EoMa_Dimensional_Gate_III,EoMa_Dimensional_Gate_II,EoMa_Dimensional_Gate
                        [/not]
                        [not]
                            #a unit can carry one item at a time
                            trait=carry_mscimitar,carry_gcarpet,carry_regenring,carry_dcloak,carry_capofpower,carry_cota,carry_spearrhami,carry_collar,carry_metamorph,carry_staffbanisher
                        [/not]
                    [/have_unit]
                [/show_if]
                message={TAKE_IT_STRING}+ _ " for later use"

                [command]
                    [object]
                        id=carry_{ID}
                        name= _ "Item collected"
                        image={IMAGE}
                        duration=scenario
                        take_only_once=no
                        description= _ "The item has been collected by the unit. As long as the unit is alive it can give the item to another adjacent friendly unit (via right-click) or equip it later (even in other scenarios). When the unit dies, the carried item is dropped on the ground so that it can be picked by other units. A unit can only carry one item at a time, unless it equips it. Do note that some items equipped on units are lost forever once these units die, while some others are recoverable. For more information check items' descriptions."
                        [filter]
                            x,y={X},{Y}
                        [/filter]
                        [effect]
                            apply_to=overlay
                            add="misc/blank-hex.png~BLIT({IMAGE},0,0)"
                        [/effect]
                    [/object]
                    [store_unit]
                        [filter]
                            id=$unit.id
                        [/filter]
                        variable=unit
                    [/store_unit]
                    [set_variables]
                        name=unit.modifications.trait
                        mode=append

                        [value]
                            id=carry_{ID} # wmllint: ignore
                            name= _ "carries: "+{NAME}#for example: "carries: Ancient Scimitar"
                            description= _ "This unit carries an item. The item has no effect on the unit, because it is unequipped. As long as the unit is alive, it can give the item to another adjacent friendly unit (via right-click) or equip it later (even in other scenarios as long as the item is compatible with the unit). When the unit dies, the carried item is dropped on the ground so that it can be picked by other units (if there is no ground, the item is lost). Do note that some items equipped on units are lost forever once these units die, while some others are recoverable. For more information check items' descriptions."+"

"+{NAME}+"
"+{TEXT}
                        [/value]
                    [/set_variables]
                    [unstore_unit]
                        variable=unit
                        find_vacant=no
                    [/unstore_unit]

                    #item transfer menu
                    [set_menu_item]
                        id=tlu_item_give_{ID}
                        description= _ "Give: "+{NAME}
                        image={ICON}~CROP(22,0,18,18)
                        [show_if]
                            [have_unit]
                                x,y=$x1,$y1
                                side=1
                                {CAN_TAKE_FILTER_WML}
                                [filter_adjacent]
                                    side=1
                                    trait=carry_{ID}
                                [/filter_adjacent]
                                [not]
                                    id=Rashti
                                [/not]
                            [/have_unit]
                        [/show_if]
                        [command]
                            #remove item from the owner
                            [object]
                                id=carry_no_{ID}
                                duration=scenario
                                take_only_once=no
                                silent=yes
                                [filter]
                                    trait=carry_{ID}
                                [/filter]
                                [effect]
                                    apply_to=overlay
                                    remove="misc/blank-hex.png~BLIT({IMAGE},0,0)"
                                [/effect]
                            [/object]
                            #take action
                            {TLU_ITEM_TAKE_ACTION {ID} {NAME} {IMAGE} {OBJ_TEXT} {CAN_TAKE_FILTER_WML} $x1 $y1 {ICON} {OBJ_EFFECT} {TRAIT_TEXT}}
                            [remove_trait]
                                trait_id=carry_{ID}
                            [/remove_trait]
                        [/command]
                    [/set_menu_item]

                    #self-equip menu
                    [set_menu_item]
                        id=tlu_item_selfequip_{ID}
                        description= _ "Equip: "+{NAME}
                        image={ICON}~CROP(22,0,18,18)
                        [show_if]
                            [have_unit]
                                x,y=$x1,$y1
                                side=1
                                {CAN_TAKE_FILTER_WML}
                                trait=carry_{ID}
                                [not]
                                    id=Rashti
                                [/not]
                            [/have_unit]
                        [/show_if]
                        [command]
                            #remove item overlay
                            [object]
                                id=carry_no_{ID}
                                duration=scenario
                                take_only_once=no
                                silent=yes
                                [filter]
                                    trait=carry_{ID}
                                [/filter]
                                [effect]
                                    apply_to=overlay
                                    remove="misc/blank-hex.png~BLIT({IMAGE},0,0)"
                                [/effect]
                            [/object]
                            #take action
                            {TLU_ITEM_TAKE_ACTION {ID} {NAME} {IMAGE} {OBJ_TEXT} {CAN_TAKE_FILTER_WML} $x1 $y1 {ICON} {OBJ_EFFECT} {TRAIT_TEXT}}
                            [remove_trait]
                                trait_id=carry_{ID}
                            [/remove_trait]
                        [/command]
                    [/set_menu_item]

                    [remove_item]
                        x,y={X},{Y}
                    [/remove_item]

                    [set_variable]
                        name=item_{ID}_picked_up
                        value=yes
                    [/set_variable]
                    [set_variable]
                        name=item_{ID}_in_use
                        value=no
                    [/set_variable]

                    #call post collect event if exists
                    [fire_event]
                        name=post_collect
                        [primary_unit]
                            x,y={X},{Y}
                        [/primary_unit]
                    [/fire_event]
                    #call item-specific event if exists
                    [fire_event]
                        name=post_take_{ID}
                        [primary_unit]
                            x,y={X},{Y}
                        [/primary_unit]
                    [/fire_event]
                    #remove self
                    [remove_event]
                        id=artifact_{ID}_event
                    [/remove_event]
                [/command]
            [/option]

            [option]
                #leave it
                message={LEAVE_IT_STRING}

                [command]
                    [allow_undo]
                    [/allow_undo]
                [/command]
            [/option]
        [/message]

        [fire_event]
            name=initialize_menu_{ID}
        [/fire_event]
    [/event]

    [event]
        name=initialize_menu_{ID}
        priority=-2
        {DEBUG "initialize menu item for: {ID}"}

        #equip in keep
        [set_menu_item]
            id=tlu_item_equip_{ID}
            description= _ "Equip: "+{NAME}
            image={ICON}~CROP(22,0,18,18)
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=1
                    {CAN_TAKE_FILTER_WML}
                    [filter_location]
                        terrain=K*^*,C*^*,*^Kov,*^Cov
                    [/filter_location]
                    [not]
                        id=Rashti
                    [/not]
                [/have_unit]
                [and]
                    [variable]
                        name=item_{ID}_picked_up
                        equals=yes
                    [/variable]
                    [and]
                        [variable]
                            name=item_{ID}_in_use
                            equals=no
                        [/variable]
                    [/and]
                [/and]
                [not]
                    [have_unit]
                        trait=carry_{ID}
                    [/have_unit]
                [/not]
            [/show_if]
            [command]
                #take action
                {TLU_ITEM_TAKE_ACTION {ID} {NAME} {IMAGE} {OBJ_TEXT} {CAN_TAKE_FILTER_WML} $x1 $y1 {ICON} {OBJ_EFFECT} {TRAIT_TEXT}}
            [/command]
        [/set_menu_item]
    [/event]
#enddef

# wmlindent: start ignoring
#define TLU_MEHIR_PORTRAIT_ELEMENTS
~BLIT($portrait_cap,0,0)~BLIT($portrait_armor,0,0)~BLIT($portrait_sunglasses,0,0)#enddef
# wmlindent: stop ignoring

#define TLU_PORTRAIT_ITEMS_FIX TYPE PORTRAIT
    [if]
        [have_unit]
            id=Mehir
            type={TYPE}
        [/have_unit]
        [then]
            {MODIFY_UNIT id=Mehir profile "portraits/{PORTRAIT}.webp{TLU_MEHIR_PORTRAIT_ELEMENTS}"}
        [/then]
    [/if]
#enddef

#define TLU_ITEM_CHECK ID ACTION
    [if]
        [variable]
            name=item_{ID}_picked_up
            equals=yes
        [/variable]
        [and]
            [variable]
                name=item_{ID}_in_use
                equals=no
            [/variable]
        [/and]
        [then]
            {DEBUG "unequipped item: {ID}"}
            {ACTION}
            [fire_event]
                name=initialize_menu_{ID}
            [/fire_event]
            [remove_event]
                id=initialize_menu_{ID}
            [/remove_event]
            [remove_event]
                id=artifact_{ID}_event
            [/remove_event]
            {VARIABLE has_unequipped_items yes}
        [/then]
    [/if]
#enddef

#define TLU_ITEM_HELP_ENTRY ID NAME IMAGE IMAGE2 TEXT
    [option]
        image={IMAGE}
        [show_if]
            [variable]
                name=item_{ID}_picked_up
                equals=yes
            [/variable]
            [and]
                [variable]
                    name=item_{ID}_in_use
                    equals=no
                [/variable]
            [/and]
        [/show_if]
        message={NAME}

        [command]
            [message]
                speaker=narrator
                message={TEXT}
                image={IMAGE2}
            [/message]
        [/command]
    [/option]
#enddef

#define TLU_ITEM_DROP_ON_DEATH_ACTION ID ID2
    [store_locations]
        variable=drop_loc
        x,y=$x1,$y1
    [/store_locations]
    {DEBUG "item lost on terrain: "+$drop_loc.terrain}

    [if]
        [have_location]
            terrain=!,Qxy,!,{EOMA_UNWALKABLE_TERRAIN_FILTER}
            find_in=drop_loc
        [/have_location]
        [then]
            {DEBUG "item over forbidden terrain"}#do not spawn item, forget item
            {CLEAR_VARIABLE item_{ID}_picked_up}
            {CLEAR_VARIABLE item_{ID}_in_use}
        [/then]
        [else]
            {DEBUG "item on ground"}
            {VARIABLE item_{ID}_loc_x $x1}
            {VARIABLE item_{ID}_loc_y $y1}
            {TLU_ARTIFACT_{ID2} $item_{ID}_loc_x $item_{ID}_loc_y}#spawn item
            {VARIABLE item_{ID}_picked_up no}
            {VARIABLE item_{ID}_in_use no}
        [/else]
    [/if]

    {CLEAR_VARIABLE drop_loc}
#enddef

#define COLLECTED_ITEM_DROP_EVENT ID ID2
    [event]
        id=collected_die_event_{ID}
        name=last breath
        first_time_only=no

        [filter]
            trait=carry_{ID}
            [not]
                id=Mehir
            [/not]
        [/filter]

        {TLU_ITEM_DROP_ON_DEATH_ACTION ({ID}) ({ID2})}
    [/event]
#enddef

#define EQUIPPED_ITEM_DROP_EVENT ID ID2
    [event]
        id=equppied_die_event_{ID}
        name=last breath
        first_time_only=no

        [filter]
            trait={ID}
            [not]
                id=Mehir
            [/not]
            [not]
                [filter_wml]
                    [status]
                        thirdrecall=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]

        {TLU_ITEM_DROP_ON_DEATH_ACTION ({ID}) ({ID2})}
    [/event]
#enddef

#define AUTOCOLLECT_ITEM ID
    {IF_VAR item_{ID}_picked_up equals no (
        [then]
            {VARIABLE item_{ID}_picked_up yes}
        [/then]
    )}
#enddef

#define FORGET_ITEM ID
    [if]
        [variable]
            name=item_{ID}_picked_up
            equals=no
        [/variable]
        [and]
            [variable]
                name=item_{ID}_in_use
                equals=no
            [/variable]
        [/and]
        [then]
            {CLEAR_VARIABLE item_{ID}_picked_up}
            {CLEAR_VARIABLE item_{ID}_in_use}
        [/then]
    [/if]
#enddef

#define ITEM_APPLIER
    [event]
        name=portraits
        first_time_only=no

        #set variables if they are not set
        [if]
            [have_unit]
                id=Mehir
                trait=capofpower
            [/have_unit]
            [then]
                {VARIABLE portrait_cap misc/portrait-cap.png}
            [/then]
            [else]
                {VARIABLE portrait_cap misc/blank-hex.png}
            [/else]
        [/if]
        [if]
            [have_unit]
                id=Mehir
                trait=cota
            [/have_unit]
            [then]
                [if]
                    [have_unit]
                        type=TLU_Mehir_Commander
                    [/have_unit]
                    [then]
                        {VARIABLE portrait_armor misc/portrait-armor-commander.png}
                    [/then]
                    [elseif]
                        [have_unit]
                            type=TLU_Mehir_Leader
                        [/have_unit]
                        [then]
                            {VARIABLE portrait_armor misc/portrait-armor-leader.png}
                        [/then]
                    [/elseif]
                    [else]
                        {VARIABLE portrait_armor misc/portrait-armor-last.png}
                    [/else]
                [/if]
            [/then]
            [else]
                {VARIABLE portrait_armor misc/blank-hex.png}
            [/else]
        [/if]

        #equip items on the default portrait by adding ~BLITs
        {TLU_PORTRAIT_ITEMS_FIX TLU_Mehir_Commander mehir-commander}
        {TLU_PORTRAIT_ITEMS_FIX TLU_Mehir_Leader mehir-leader}
        {TLU_PORTRAIT_ITEMS_FIX TLU_The_Last_Summoner mehir-last}
    [/event]

    [event]
        name=prestart

        [fire_event]
            name=portraits
        [/fire_event]
    [/event]

    #the stylish achievement check
    [event]
        name=stylish
        first_time_only=no

        [if]
            [have_unit]
                id=Mehir
                [and]
                    trait=mscimitar
                    [and]
                        trait=regenring
                        [and]
                            trait=cota
                            [and]
                                trait=capofpower
                            [/and]
                        [/and]
                    [/and]
                [/and]
            [/have_unit]
            [then]
                {TLU_SET_ACHIEVEMENT tlu_stylish}
            [/then]
        [/if]
    [/event]

    #collected item drop events
    {COLLECTED_ITEM_DROP_EVENT mscimitar SCIMITAR}
    {COLLECTED_ITEM_DROP_EVENT spearrhami SPEAR}
    {COLLECTED_ITEM_DROP_EVENT staffbanisher STAFF}
    {COLLECTED_ITEM_DROP_EVENT metamorph AMULET}
    {COLLECTED_ITEM_DROP_EVENT sphere SPHERE}
    {COLLECTED_ITEM_DROP_EVENT dcloak CLOAK}
    {COLLECTED_ITEM_DROP_EVENT gcarpet CARPET}
    {COLLECTED_ITEM_DROP_EVENT capofpower CAP}
    {COLLECTED_ITEM_DROP_EVENT cota ARMOR}
    {COLLECTED_ITEM_DROP_EVENT collar COLLAR}
    {COLLECTED_ITEM_DROP_EVENT regenring RING}

    #equipped item drop events
    {EQUIPPED_ITEM_DROP_EVENT mscimitar SCIMITAR}
    {EQUIPPED_ITEM_DROP_EVENT spearrhami SPEAR}
    {EQUIPPED_ITEM_DROP_EVENT staffbanisher STAFF}
    {EQUIPPED_ITEM_DROP_EVENT metamorph AMULET}
    {EQUIPPED_ITEM_DROP_EVENT sphere SPHERE}

    #enable menu items for collected but unequipped items on scenario start
    [event]
        ## name=simulate_start
        name=start
        priority=-1#post start

        ## [put_to_recall_list]
        ## side=1
        ## [not]
        ## canrecruit=yes
        ## [/not]
        ## [/put_to_recall_list]

        {TLU_ITEM_CHECK mscimitar ({TLU_ARTIFACT_SCIMITAR 1 1})}
        {TLU_ITEM_CHECK gcarpet ({TLU_ARTIFACT_CARPET 1 1})}
        {TLU_ITEM_CHECK regenring ({TLU_ARTIFACT_RING 1 1})}
        {TLU_ITEM_CHECK dcloak ({TLU_ARTIFACT_CLOAK 1 1})}
        {TLU_ITEM_CHECK capofpower ({TLU_ARTIFACT_CAP 1 1})}
        {TLU_ITEM_CHECK cota ({TLU_ARTIFACT_ARMOR 1 1})}
        {TLU_ITEM_CHECK spearrhami ({TLU_ARTIFACT_SPEAR 1 1})}
        {TLU_ITEM_CHECK collar ({TLU_ARTIFACT_COLLAR 1 1})}
        {TLU_ITEM_CHECK metamorph ({TLU_ARTIFACT_AMULET 1 1})}
        {TLU_ITEM_CHECK staffbanisher ({TLU_ARTIFACT_STAFF 1 1})}
        {TLU_ITEM_CHECK sphere ({TLU_ARTIFACT_SPHERE 1 1})}

        {REMOVE_IMAGE 1 1}

        {IF_VAR has_unequipped_items equals yes (
            [then]
                [message]
                    speaker=narrator
                    message= _ "You still have unequipped items in your possession. To equip them, right-click a unit in a keep or in a castle tile to give it a compatible item of your choosing. For more detailed information about equipping items, right-click anywhere on the map."
                    image=portraits/narrator.webp
                    [show_if]
                        [variable]
                            name=has_unequipped_items
                            equals=yes
                        [/variable]
                    [/show_if]
                [/message]
                [set_menu_item]
                    id=z_items_help
                    description= _ "Items Help"
                    image="items/book2.png~CROP(21,23,27,24)~SCALE(20,20)"

                    [command]
                        [message]
                            speaker=narrator
                            image=portraits/narrator.webp
                            message= _ "You still have unequipped items in your possession. To equip them, right-click a unit in a keep or in a castle tile to give that unit a compatible item of your choosing.

Below is a list of unequipped items. Choose an item from the list to learn more about what it does and who can equip it. Do note that some items equipped on units are lost forever once these units die, while some others are recoverable. For more information check items' descriptions."
                            {TLU_ITEM_HELP_ENTRY cota "Ancient Cuirass" "items/armor.png" "misc/artifact-armor.png" ({DESCR_ARMOR})}
                            {TLU_ITEM_HELP_ENTRY metamorph "Amulet of Metamorph" "items/necklace.png" "misc/artifact-amulet.png" ({DESCR_AMULET})}
                            {TLU_ITEM_HELP_ENTRY mscimitar "Ancient Scimitar" "items/scimitar.png" "misc/artifact-scimitar.png" ({DESCR_SCIMITAR})}
                            {TLU_ITEM_HELP_ENTRY staffbanisher "Banishment Staff" "items/staff-magic.png" "misc/artifact-staff.png" ({DESCR_STAFF})}
                            {TLU_ITEM_HELP_ENTRY capofpower "Cap of Power" "items/cap.png" "misc/artifact-cap.png" ({DESCR_CAP})}
                            {TLU_ITEM_HELP_ENTRY collar "Collar of Recall" "items/collar.png" "misc/artifact-collar.png" ({DESCR_COLLAR})}
                            {TLU_ITEM_HELP_ENTRY dcloak "Desert Cloak" "items/cloak.png" "misc/artifact-cloak.png" ({DESCR_CLOAK})}
                            {TLU_ITEM_HELP_ENTRY gcarpet "Golden Carpet" "items/carpet.png" "misc/artifact-carpet.png" ({DESCR_CARPET})}
                            {TLU_ITEM_HELP_ENTRY regenring "Ring of Regeneration" "items/ring-red.png" "misc/artifact-ring.png" ({DESCR_RING})}
                            {TLU_ITEM_HELP_ENTRY spearrhami "Spear of the Rhami" "items/spear-rhami.png" "misc/artifact-spear.png" ({DESCR_SPEAR})}
                            {TLU_ITEM_HELP_ENTRY sphere "Reficul's Sphere" "items/ball-magenta.png" "misc/artifact-orb.png" ({DESCR_SPHERE})}
                            [option]
                                message= _ "Exit"
                            [/option]
                        [/message]
                    [/command]
                [/set_menu_item]
            [/then]
        )}
    [/event]

    #item-related cleanup on victory
    [event]
        name=victory

        [remove_trait]
            trait_id=carry_mscimitar
        [/remove_trait]
        [remove_trait]
            trait_id=carry_gcarpet
        [/remove_trait]
        [remove_trait]
            trait_id=carry_dcloak
        [/remove_trait]
        [remove_trait]
            trait_id=carry_regenring
        [/remove_trait]
        [remove_trait]
            trait_id=carry_capofpower
        [/remove_trait]
        [remove_trait]
            trait_id=carry_cota
        [/remove_trait]
        [remove_trait]
            trait_id=carry_spearrhami
        [/remove_trait]
        [remove_trait]
            trait_id=carry_collar
        [/remove_trait]
        [remove_trait]
            trait_id=carry_metamorph
        [/remove_trait]
        [remove_trait]
            trait_id=carry_staffbanisher
        [/remove_trait]
        [remove_trait]
            trait_id=carry_sphere
        [/remove_trait]

        {IF_VAR auto_grab_items equals yes (
            [then]
                {AUTOCOLLECT_ITEM mscimitar}
                {AUTOCOLLECT_ITEM spearrhami}
                {AUTOCOLLECT_ITEM metamorph}
                {AUTOCOLLECT_ITEM staffbanisher}
                {AUTOCOLLECT_ITEM sphere}
            [/then]
            [else]
                {FORGET_ITEM mscimitar}
                {FORGET_ITEM spearrhami}
                {FORGET_ITEM metamorph}
                {FORGET_ITEM staffbanisher}
                {FORGET_ITEM sphere}
            [/else]
        )}

        {CLEAR_VARIABLE item_mscimitar_loc_x}
        {CLEAR_VARIABLE item_mscimitar_loc_y}
        {CLEAR_VARIABLE item_gcapret_loc_x}
        {CLEAR_VARIABLE item_gcarpet_loc_y}
        {CLEAR_VARIABLE item_dcloak_loc_x}
        {CLEAR_VARIABLE item_dcloak_loc_y}
        {CLEAR_VARIABLE item_regenring_loc_x}
        {CLEAR_VARIABLE item_regenring_loc_y}
        {CLEAR_VARIABLE item_capofpower_loc_x}
        {CLEAR_VARIABLE item_capofpower_loc_y}
        {CLEAR_VARIABLE item_cota_loc_x}
        {CLEAR_VARIABLE item_cota_loc_y}
        {CLEAR_VARIABLE item_spearrhami_loc_x}
        {CLEAR_VARIABLE item_spearrhami_loc_y}
        {CLEAR_VARIABLE item_collar_loc_x}
        {CLEAR_VARIABLE item_collar_loc_y}
        {CLEAR_VARIABLE item_metamorph_loc_x}
        {CLEAR_VARIABLE item_metamorph_loc_y}
        {CLEAR_VARIABLE item_staffbanisher_loc_x}
        {CLEAR_VARIABLE item_staffbanisher_loc_y}
        {CLEAR_VARIABLE item_sphere_loc_x}
        {CLEAR_VARIABLE item_sphere_loc_y}
        {CLEAR_VARIABLE has_unequipped_items}
    [/event]

    #universal post take events
    [event]
        name=post_take_cota
        first_time_only=no
        [if]
            [have_unit]
                id=Mehir
                x,y=$x1,$y1
            [/have_unit]
            [then]
                {VARIABLE portrait_armor misc/portrait-armor-commander.png}
                {MODIFY_UNIT id=Mehir profile "portraits/mehir-commander.webp~BLIT($portrait_cap,0,0)~BLIT($portrait_armor,0,0)"}
            [/then]
        [/if]
        [fire_event]
            name=portraits
        [/fire_event]
    [/event]

    [event]
        name=post_take_collar
        first_time_only=no
        [if]
            [have_unit]
                trait=collar
                x,y=$x1,$y1
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=unit
                [/store_unit]
                {VARIABLE unit.status.collar yes}
                {VARIABLE unit.status.firstrecall yes}
                {VARIABLE unit.status.secondrecall yes}
                {VARIABLE unit.status.thirdrecall yes}
                {VARIABLE collar_slot $unit.variables.artifact_count}
                {VARIABLE_OP collar_slot add -10}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
                [unit_overlay]
                    id=$unit.id
                    image="misc/blank-hex.png~BLIT(misc/artifact-icon-collar3.png,$collar_slot,0)"
                [/unit_overlay]
                {REMOVE_IMAGE $x1 $y1}
            [/then]
        [/if]
    [/event]
#enddef

#define PORTRAIT_FIX
    [event]
        name=portraits
        first_time_only=no

        {VARIABLE portrait_cap misc/blank-hex.png}
        {VARIABLE portrait_armor misc/blank-hex.png}
        {TLU_PORTRAIT_ITEMS_FIX TLU_Mehir_Guard mehir}
    [/event]

    [event]
        name=prestart

        [fire_event]
            name=portraits
        [/fire_event]
    [/event]
#enddef
